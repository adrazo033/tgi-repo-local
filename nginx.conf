worker_processes auto;
events { worker_connections 1024; }

http {
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    server_tokens off;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Upstream que apunta a TGI (asegurar de arrancar TGI en --port 8080)
    upstream tgi_backend {
        server localhost:8080 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    server {
        listen 80;
        server_name _;

        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # --- redirect raíz del servidor a la ruta base pública (opcional) ---
        location = / {
            return 302 https://$host/system/services/tgi-test8/exposed/;
        }

        
        location ~ ^/system/services/([^/]+)/exposed$ {
            add_header Content-Type text/plain;
            return 200 "OK";
        }

        location = /system/services/([^/]+)/exposed {
            return 301 $scheme://$host/system/services/$1/exposed/;
        }

        # /system/services/tgi-test8/exposed/  -> redirige a la UI/docs raíz (v1)
        location = /system/services/([^/]+)/exposed/ {
            # Si quieres que vaya a la docs UI por defecto:
            return 302 $scheme://$host/system/services/$1/exposed/docs;
            # Si prefieres que vaya a /v1/ en general, usa: return 302 $scheme://$host/system/services/$1/exposed/v1/;
        }

        # -----------------------
        # Documentación: Swagger UI
        # /system/services/tgi-test8/exposed/v1/docs  -> /docs (backend)
        # -----------------------
        location ~ ^/system/services/([^/]+)/exposed/v1/docs$ {
            rewrite ^/system/services/([^/]+)/exposed/v1/docs$ /docs break;
            proxy_pass http://tgi_backend;

            proxy_set_header Accept-Encoding "";
            sub_filter_once off;

            # Cambia la ruta que Swagger UI usa para cargar el JSON
            sub_filter "url: '/openapi.json'" "url: '/system/services/$1/exposed/openapi.json'";
        }

        # -----------------------
        # Model docs (por modelo)
        # /system/services/tgi-test8/exposed/v1/models/<MODEL>/docs  -> /docs (assuming shared docs)
        # -----------------------
        location ~ ^/system/services/([^/]+)/exposed/v1/models/([^/]+)/docs$ {
            rewrite ^/system/services/([^/]+)/exposed/v1/models/([^/]+)/docs$ /docs break;
            proxy_pass http://tgi_backend;

            proxy_set_header Accept-Encoding "";
            sub_filter_once off;

            sub_filter "url: '/openapi.json'" "url: '/system/services/$1/exposed/openapi.json'";
        }

        # -----------------------
        # Proxy general: todo lo demás bajo /system/services/tgi-test8/exposed/ -> backend
        # -----------------------
        location ~ ^/system/services/([^/]+)/exposed/(.*)$ {
            rewrite ^/system/services/[^/]+/exposed/(.*)$ /$1 break;
            proxy_pass http://tgi_backend;

            # necesario para sub_filter en algunas respuestas
            proxy_set_header Accept-Encoding "";

            # (Opcional) aumentar body size si esperas cargas grandes
            client_max_body_size 50m;
        }

        # Deniega acceso a ficheros ocultos
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }
    }
}

